/**************************************************************************
 *	Project: IconEdit file manager tool
 *
 *	File:	foldered.goc
 *
 *		
 *
 *	By RABE-Soft, Rainer Bettsteller, for Free PC/GEOS Project
 *
 **************************************************************************/

@include <stdapp.goh>
@include <fmtool.goh>
#include <Ansi/string.h>
#include <Ansi/stdio.h>
#include <token.h>
#include <initfile.h>

@include "foldered.goh"
@include "fedui.goh"

/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  +                                                                         +
  +	Global variables and classes			            	    +
  +                                                                         +
  ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/

static	optr		g_dialog = NullOptr;
static	MemHandle 	g_mh;
static	GeodeToken	g_selectedToken;
static 	MemHandle 	g_tokenList = 0;	/* List of all Tokens in the TokenDB */
static 	word		g_displaySize = DEFAULT_TOKEN_DISPLAY_SIZE;
static 	word		g_tokenStyle = DEFAULT_TOKEN_STYLE;
static 	optr 		g_configDialog = NullOptr;
static 	word 		g_configBits = DEFAULT_FED_CONFIG;


@classdecl FolderEdInteractionClass;

	/*
	 * VisMonikers declared in Art folder
	 */
@extern visMoniker IconNotFoundMoniker;
@extern visMoniker CloseImageMoniker;
@extern visMoniker SettingsImageMoniker;
@extern visMoniker SettingOKImageMoniker;
@extern visMoniker DefaultImageMoniker;

/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  +                                                                         +
  +	Initialize and exit the tool			            	    +
  +	----------------------------			            	    +
  +	- Required API functions					    +	
  +	- Setup the UI objects						    +	
  +	- Clean up							    +	
  +                                                                         +
  ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/


/*-------------------------------------------------------------
 *	API Struct	- tell the file manager infos about our tools
 *	MUST be global
-------------------------------------------------------------*/
FMToolStruct FMToolInfo[1] = {
    {
        @FolderEditMoniker, (FMTF_SELECTED_ONLY | FMTT_DIALOG), 1
        	/* Moniker for Tool Entry
        	 * FMTF_SELECTED_ONLY: active, onyl if a file/folder is selected
        	 * FMTT_DIALOG: a dialog will come up (see FMToolType). 
        	 * 1: number of the tool in our list (we have only one)
        	 */
    }
};

/*-------------------------------------------------------------
 *	FMFetchToolsProc GetThoseTools
 *	FileManager API Function - fetch Tools
-------------------------------------------------------------*/

word _pascal _export GetThoseTools(FMToolStruct **tablePtr)
{
    *tablePtr = (FMToolStruct*) &FMToolInfo;
    return 1;
}


/*-------------------------------------------------------------
 *	FMToolProc FolderEdToolStart()
 *-------------------------------------------------------------
 *	GeodeHandle filemgr => Process that is subclass of FileManagerClass
 *	word toolNum =>	Entry # of activated tool within table returned by
 *                FMTF_FETCH_TOOLS
 *	word entryNum
 *
 *	The user has clicked on our Utilities menu item: "Edit Folder Icon"
-------------------------------------------------------------*/
// stop in foldered::FolderEdToolStart
void _pascal _export FolderEdToolStart(GeodeHandle filemgr,
    					word toolNum,
					word entryNum ) {
SelectedFilesStruct	*fileInfo;
word	count;
GeodeToken 	tok;
Boolean err;

{word x = toolNum; x= entryNum; x=x; }	// supress compiler warning



    /*
     * Copy our dialog template and add it to the application object
     */
    g_dialog = UserCreateDialog(@SelectDialog);
   
   
   /*
    *	Enable expert UI - token style group, huge icon etc
    */
    err = InitFileReadInteger (Fed_Ini_Category, Fed_Ini_Key, &g_configBits);
    if (err) g_configBits = DEFAULT_FED_CONFIG;
    FEDConfigureToolUI();

   
    /*
     * Initialize duplicated dialog objects
     */
    @send @DialogObj(@SelectOkTrigger)::MSG_GEN_TRIGGER_SET_DESTINATION(g_dialog);
    @send @DialogObj(@SelectOkTrigger2)::MSG_GEN_TRIGGER_SET_DESTINATION(g_dialog);
    @send @DialogObj(@SelectSettingsTrigger)::MSG_GEN_TRIGGER_SET_DESTINATION(g_dialog);
    @send @DialogObj(@ClearTokenTrigger)::MSG_GEN_TRIGGER_SET_DESTINATION(g_dialog);
    @send @DialogObj(@ClearTokenTrigger2)::MSG_GEN_TRIGGER_SET_DESTINATION(g_dialog);
    @send @DialogObj(@SelectCancelTrigger)::MSG_GEN_TRIGGER_SET_DESTINATION(g_dialog);
    @send @DialogObj(@SelectFolderList)::MSG_GEN_ITEM_GROUP_SET_DESTINATION(g_dialog);
    @send @DialogObj(@FEDTokenList)::MSG_GEN_ITEM_GROUP_SET_DESTINATION(g_dialog);
    @send @DialogObj(@FEDManufIDApplayTrigger)::MSG_GEN_TRIGGER_SET_DESTINATION(g_dialog);
    @send @DialogObj(@FEDDisplaySizeSelector)::MSG_GEN_ITEM_GROUP_SET_DESTINATION(g_dialog);
    @send @DialogObj(@FEDTokenStyleSelector)::MSG_GEN_ITEM_GROUP_SET_DESTINATION(g_dialog);
    @send @DialogObj(@FEDApplyToAllSelector)::MSG_GEN_BOOLEAN_GROUP_SET_DESTINATION(g_dialog);
    
    tok.GT_chars[0]='n'; tok.GT_chars[1]='F'; tok.GT_chars[2]='D'; 
    tok.GT_chars[3]='R'; tok.GT_manufID=0;
    FEDShowToken(tok, 0, @DialogObj(@TokenDefaultDisplay), 0, @DialogObj(@TokenDefaultTool));

    InternalCreateButtonMonikers();	
    
    /*
     * Figure out the selected folders
     */
    g_mh = @call ConstructOptr(filemgr, 0)::MSG_FM_GET_SELECTED_FILES();
    if ( !g_mh ) return;	// be save to avoid crash, should not occur.
    
    count = FEDLookForFoldersInList();
    if (!count) {
    	/*
    	 * No Folders selected. Exit cleanly
    	 */
    	ErrorBoxOptr(@ErrorNoFolders);
    	UserDestroyDialog(g_dialog);
    	MemFree(g_mh);
    	g_mh = 0;
    	return;
    }
    
    /*
     * Create list of tokens and initialize the FEDTokenList
     */
    count = FEDListTokens();
    @send @DialogObj(@FEDTokenList)::MSG_GEN_DYNAMIC_LIST_INITIALIZE(count);
    
    /*
     * Initialize the folder list (sending it's apply msg is required!). 
     * If only one foldes was selected, or show folder name only
     */
    fileInfo = MemLock(g_mh);
    @send @DialogObj(@SelectFolderList)::MSG_GEN_DYNAMIC_LIST_INITIALIZE(fileInfo->header.FQTH_numFiles);
    @send @DialogObj(@SelectFolderList)::MSG_GEN_ITEM_GROUP_SET_SINGLE_SELECTION(0, FALSE);
    @send @DialogObj(@SelectFolderList)::MSG_GEN_ITEM_GROUP_SET_MODIFIED_STATE(TRUE);
    @send @DialogObj(@SelectFolderList)::MSG_GEN_APPLY();
    if (fileInfo->header.FQTH_numFiles > 1) { 
	
    } else {
	@send @DialogObj(@SelectFolderList)::MSG_GEN_SET_NOT_USABLE(VUM_NOW);
	@send @DialogObj(@FEDApplyToAllSelector)::MSG_GEN_SET_NOT_USABLE(VUM_NOW);
    }
    MemUnlock(g_mh);

    /*
     * initialize more UI objects
     */
    @send  @DialogObj(@FEDTokenInfoCount)::MSG_GEN_VALUE_SET_INTEGER_VALUE(count, FALSE);
    @send  @DialogObj(@FEDTokenInfoDisplayed)::MSG_GEN_VALUE_SET_INTEGER_VALUE(count, FALSE);

    @send @DialogObj(@FEDApplyToAllSelector)::MSG_GEN_BOOLEAN_GROUP_SET_GROUP_STATE(g_configBits & FED_CFG_APPLY_TO_ALL, FALSE);
    @send @DialogObj(@FEDApplyToAllSelector)::MSG_GEN_BOOLEAN_GROUP_SET_GROUP_MODIFIED_STATE(0xFFFF, 0);
    @send @DialogObj(@FEDApplyToAllSelector)::MSG_GEN_APPLY();

    /*
     * Finally, open dialog box
     */
    @send g_dialog::MSG_GEN_INTERACTION_INITIATE();

}

/*-------------------------------------------------------------
 * InternalCreateButtonMonikers
 *-------------------------------------------------------------
 *	Setup dialog button monikers.
 *	Used twice.
-------------------------------------------------------------*/
void InternalCreateButtonMonikers(void) {

    /*
     * Combine icon and text moniker into a single combination moniker.
     * I use my own routine. Perhaps, UserCreateIconTextMoniker() is also possible.
     */
    CreateButtonMoniker(@DialogObj(@SelectCancelTrigger), @CloseImageMoniker, @CloseTextMoniker);
    CreateButtonMoniker(@DialogObj(@SelectOkTrigger2), @SettingOKImageMoniker, @ApplyIconTextMoniker);
    CreateButtonMoniker(@DialogObj(@ClearTokenTrigger2), @DefaultImageMoniker, @DefaultIconTextMoniker);
    CreateButtonMoniker(@DialogObj(@SelectSettingsTrigger), @SettingsImageMoniker, @SettingsTextMoniker);

}

/*-------------------------------------------------------------
 * FEDListTokens
 *-------------------------------------------------------------
 *	Create al list of all tokens in the tokenDB
 *	Return: Number of tokens in TokenDB
-------------------------------------------------------------*/
word FEDListTokens(void) {
TokenListStruct	*list;
dword	retVal;
word count, minIdx, topIdx, n;


    if (g_tokenList) MemFree(g_tokenList);	// Destroy old list

	/*
	 *	6 byte header to use TokenListStruct for access
	 */
    retVal = TokenListTokens(TRF_ONLY_GSTRING, 6, 0);
    g_tokenList = TokenListTokensHandleFromDWord(retVal);
    if( !g_tokenList ) return 0;			// BAD	
    count = TokenListTokensCountFromDWord(retVal);
    
    list = MemLock(g_tokenList);
    list->tokenCount = count;
    list->firstIndex = 0;
    list->tokensToShow = count;
    
	/*
	* Sort list by Manufacturer ID
	* topIdx: 	start of the unsorted list part
	* minIdx:	index of smallest token ID in unsorted list part 
	*/
    for (topIdx = 0; topIdx<(count-1); topIdx++) {
	
	minIdx = topIdx;	// assume: smalles ID is on top
	
	// check all following tokens to see if the ID is smaller
	// find the index of the smallest token ID
	for ( n = topIdx+1; n < count; n++) {
	    if (list->token[n].GT_manufID < list->token[minIdx].GT_manufID) minIdx = n;
	    }
    
    	if (minIdx != topIdx) {
    	    // smaller ID found. swap tokens
    	    GeodeToken tmpToken = list->token[topIdx];
    	    list->token[topIdx] = list->token[minIdx];
    	    list->token[minIdx] = tmpToken;
    	    }
    }

    MemUnlock(g_tokenList);
	
    return count;	
	
}


/*-------------------------------------------------------------
 * FEDLookForFoldersInList	
 *-------------------------------------------------------------
 *	Scan file list and select folders only
 ------------------------------------------------------------*/
word FEDLookForFoldersInList(void) {
word count, n;
FileOperationInfoEntry	*srcEntry, *destEntry;
SelectedFilesStruct	*fileInfo;

    fileInfo = MemLock(g_mh);
    
    srcEntry  = &(fileInfo->entry[0]);
    destEntry = srcEntry;
    count = 0;
    
    for ( n = 0; n < fileInfo->header.FQTH_numFiles; n++) {
    
    	if ( (srcEntry->FOIE_type == GFT_DIRECTORY) ||
    	     ( (srcEntry->FOIE_type == GFT_NOT_GEOS_FILE) && (srcEntry->FOIE_attrs & FA_SUBDIR) ) ) {
    	    /*
    	     *	It's a folder. Move it up and count it
    	     */
    	    *destEntry = *srcEntry;
    	    destEntry++;    	     
    	    count++;
    	}
    	srcEntry++;
    }
     
    fileInfo->header.FQTH_numFiles = count;	// only deal with the found folders
    MemUnlock(g_mh);
     
    return count;
 
 }
    
/*-------------------------------------------------------------
 * CreateButtonMoniker
 *-------------------------------------------------------------
 *	Build a Moniker from a graphic an a localizable text
-------------------------------------------------------------*/
// stop in foldered::CreateButtonMoniker
void CreateButtonMoniker(optr button, optr graphicMoniker, optr textMoniker) {
MemHandle	gsHandle;
GStateHandle	gsState;
word 		gsChunk; // ChunkHandle 	gsChunk;
optr		gsOptr;

word		lElem;
Handle		monikerGString;
//MemHandle 	mh;
//word 		monikerSize;
byte 		*bPtr;
VisMonikerWithGString	*monikerPtr;
int		w, h, tw, th, y;
word 	fontID, fSize, size, flags;
Boolean err;
FileLongName	fontName;
Rectangle r;


    if ( g_configBits & FFED_CFG_HIDE_BUTTON_ICONS)  {
    
        /*
         * Send text-only moniker to buttons
         */
         
        MemLock(OptrToHandle(textMoniker));
        @call button::MSG_GEN_REPLACE_VIS_MONIKER_TEXT(LMemDeref(textMoniker), VUM_NOW);
        MemUnlock(OptrToHandle(textMoniker));
        return;
        }   

    /*
     * Create Gstring to hold Images
     */
     
    gsHandle = MemAllocLMem(LMEM_TYPE_GENERAL, 0);
    gsState = GrCreateGString( gsHandle, GST_CHUNK, &gsChunk);
    gsOptr = ConstructOptr(gsHandle, gsChunk);

    /*
     *	Lock graphic Image (a visMoniker in a sharable resource) and draw it
     */
    MemLock(OptrToHandle(graphicMoniker));
    
    bPtr = LMemDeref(graphicMoniker);
    monikerPtr = (VisMonikerWithGString*)bPtr;
    w = monikerPtr->VMWGS_common.VM_width;
    h = monikerPtr->VMWGS_height;

    // bPtr must point to the gstring itself
    bPtr += sizeof(VisMonikerWithGString);
    monikerGString = GrLoadGString(PtrToSegment(bPtr), GST_PTR, PtrToOffset(bPtr));

    GrDrawGString(gsState, monikerGString, 0, 0, 0, &lElem);
    GrDestroyGString(monikerGString, NULL, GSKT_LEAVE_DATA);
    MemUnlock(OptrToHandle(graphicMoniker));
    
    /*
     * Set correct font and size
     */
    err = InitFileReadInteger ("ui", "fontSize", &fSize);
    if (err) fSize = 12;

    memset(fontName, 0, sizeof(FileLongName));
    flags = (IFCC_INTACT << IFRF_CHAR_CONVERT_OFFSET) | sizeof(FileLongName);	// pass buffer size and convert method
    if ( InitFileReadStringBuffer("ui", "fontid", fontName, flags, &size) ) strcpy(fontName, "Berkeley");
    fontID = GrCheckFontAvailName(FEF_BITMAPS | FEF_OUTLINES | FEF_STRING, 0, fontName);
    if ( !fontID ) fontID = FID_BERKELEY;
    
    GrSetFont(gsState, fontID, MakeWWFixed(fSize));
    
    
    /*
     * Lock the text and draw it vertically centerd on the right of the graphic
     */
    MemLock(OptrToHandle(textMoniker));
    
    GrGetTextBounds (gsState, LMemDeref(textMoniker), //const char _far *str, 
			    0, 0, // word xpos, word ypos, 
			    0, &r); //word count, Rectangle *bounds);    
    tw = r.R_right - r.R_left;
    th = r.R_bottom - r.R_top;
    y = (h-th)/2;
    h = (h>th) ? h : th;

    w += 5;
    GrDrawText(gsState, w, y, LMemDeref(textMoniker), 0); 
    
    
    /*
     * Unlock data resource and send the gstring as moniker to the object
     */
    MemUnlock(OptrToHandle(textMoniker));
    
    GrEndGString(gsState);    
    @call button::MSG_GEN_REPLACE_VIS_MONIKER(
    				VUM_NOW, 	// VisUpdateMode updateMode,
    				h, w+tw, 0, 	//word height, word width, word length,
    				VMDT_GSTRING,	// VisMonikerDataType dataType,
    				VMST_OPTR,	// VisMonikerSourceType sourceType,
				gsOptr		//dword source) = ax;
    				);

    GrDestroyGString(gsState,0,GSKT_KILL_DATA);
    MemFree(gsHandle);
	
}
 
/*-------------------------------------------------------------
 * void MSG_FED_QUIT_DIALOG(int action);	
 *-------------------------------------------------------------
 *	Close and destroy dialog box
-------------------------------------------------------------*/
// stop in foldered::FolderEdInteractionFED_QUIT_DIALOG
@method FolderEdInteractionClass, MSG_FED_QUIT_DIALOG {
optr 	applyTrigger, cancelTrigger;
word oldBits;

    switch (action) {
    case ACTION_OPEN_CONFIG:
    	@send g_dialog::MSG_GEN_GUP_INTERACTION_COMMAND(IC_DISMISS);
    	g_configDialog = UserCreateDialog(@ConfigDialog);
    	applyTrigger = ConstructOptr(OptrToHandle(g_configDialog), OptrToChunk(@ConfigApplyTrigger));
    	cancelTrigger = ConstructOptr(OptrToHandle(g_configDialog), OptrToChunk(@ConfigCancelTrigger));
    	
        @send applyTrigger::MSG_GEN_TRIGGER_SET_DESTINATION(g_dialog);
        @send cancelTrigger::MSG_GEN_TRIGGER_SET_DESTINATION(g_dialog);
 	CreateButtonMoniker(applyTrigger, @SettingOKImageMoniker, @ConfigApplyTextMoniker);
	CreateButtonMoniker(cancelTrigger, @CloseImageMoniker, @ConfigCancelTextMoniker);
	@send ConstructOptr(OptrToHandle(g_configDialog), OptrToChunk(@ConfigOptions))::MSG_GEN_BOOLEAN_GROUP_SET_GROUP_STATE(g_configBits & FED_MAIN_CONFIG_MASK, 0);
    	@send g_configDialog::MSG_GEN_INTERACTION_INITIATE();
	
    	break;
    	
    case ACTION_CLOSE_CONFIG_APPLY:
        oldBits = g_configBits;
    	g_configBits = @call ConstructOptr(OptrToHandle(g_configDialog), OptrToChunk(@ConfigOptions))::MSG_GEN_BOOLEAN_GROUP_GET_SELECTED_BOOLEANS();
    	g_configBits |= @call @DialogObj(@FEDApplyToAllSelector)::MSG_GEN_BOOLEAN_GROUP_GET_SELECTED_BOOLEANS();
    	FEDConfigureToolUI();
    	if ((oldBits ^ g_configBits) & FFED_CFG_HIDE_BUTTON_ICONS) InternalCreateButtonMonikers();
    	
    case ACTION_CLOSE_CONFIG_CANCEL:
    	if (g_configDialog) {
    	    UserDestroyDialog(g_configDialog);
    	    g_configDialog = 0;
    	    @send g_dialog::MSG_GEN_INTERACTION_INITIATE();
    	}
    	break;
    	
    case ACTION_CLOSE_TOOL:
    default:
    	InitFileWriteInteger(Fed_Ini_Category, Fed_Ini_Key, g_configBits);
	UserDestroyDialog(g_dialog); // close and destroy the dialog
	if (g_mh) MemFree(g_mh);
	if (g_tokenList) MemFree(g_tokenList);

	/* Important: set memory handles to zero for next call to the tool */
	g_mh = 0;
	g_tokenList = 0;
    	break;
    }


}

/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  +                                                                         +
  +	Common tool routines				            	    +
  +	--------------------				            	    +
  +	Handle token moniker and ID string				    +	
  +     								    +
  ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/

/*-------------------------------------------------------------
 *	FEDShowToken
 *-------------------------------------------------------------
 *	Display Icon Monikers and ID
 -------------------------------------------------------------*/
// swat stop in foldered::FEDShowToken
void  FEDShowToken(GeodeToken tok, optr idObj, optr monikerObj, optr hugeObj, optr toolObj) {
#define NUM_CHARS_IN_ID	0
char 		buf[15];	// may hold "abcd, 12345"	
MemHandle 	mh;
word 		monikerSize;
VisMonikerWithGString	*moniker;
int x, y;

    if (idObj) {
    	FEDTokenIdToText(tok, 0, buf);
    	@call idObj::MSG_GEN_REPLACE_VIS_MONIKER_TEXT(buf, 0);
    }
    
    FEDShowTokenMoniker(tok, monikerObj);

    if ( hugeObj) {
	mh = InternalGetTokenMonikerBlock(tok, DS_HUGE, VMS_ICON, &monikerSize);
	if ( mh ) 
	{
	    /*
	     * If there is no huge icon, InternalGetTokenMonikerBlock returns a smaller icon.
	     * But we only want to display a large or huge icon, not a standard size icon. 
	     * The standard size is 48x30, so a larger icon should extend this size 
	     * at least in one direction. Since some "standard" icons are slightly 
	     * larger, we use 5 pixels difference.
	     */
	    moniker = MemLock(mh);
	    x = moniker->VMWGS_common.VM_width;
	    y = moniker->VMWGS_height;
	    MemUnlock(mh);
	    
	    if ( (x <= 48+5) && (y <= 30+5) ) {
	    	// This is not a huge or large moniker
	    	@call hugeObj::MSG_GEN_REPLACE_VIS_MONIKER_TEXT("",VUM_NOW);	
	    } else {
	    	@call hugeObj::MSG_GEN_REPLACE_VIS_MONIKER(VUM_NOW, 
			40,64,monikerSize,
			VMDT_VIS_MONIKER ,VMST_FPTR,(dword)MemLock(mh));
	    }
	    MemFree(mh);
	}
	else {
	    
	    @call hugeObj::MSG_GEN_REPLACE_VIS_MONIKER_TEXT("",VUM_NOW);
	}
    }	

    if ( toolObj) {
	mh = InternalGetTokenMonikerBlock(tok, DS_TINY, VMS_TOOL, &monikerSize);
	if ( mh ) 
	{
	    /*
	     * Again, we check the size of the returned moniker.
	     * The default tool size is 15x15, so a tool should not extend the size of 
	     * 15+5=20 pixels in any direction.
	     */
	    moniker = MemLock(mh);
	    x = moniker->VMWGS_common.VM_width;
	    y = moniker->VMWGS_height;
	    MemUnlock(mh);
	    
	    if ( (x > 15+5) || (y > 15+5) ) {
	    	// This is not a tool moniker
	    	@call toolObj::MSG_GEN_REPLACE_VIS_MONIKER_TEXT("",VUM_NOW);	
	    } else {	
		@call toolObj::MSG_GEN_REPLACE_VIS_MONIKER(VUM_NOW, 
			40,64,monikerSize,
			VMDT_VIS_MONIKER ,VMST_FPTR,(dword)MemLock(mh));
	    }
	MemFree(mh);
	}
	else {
	    @call toolObj::MSG_GEN_REPLACE_VIS_MONIKER_TEXT("",VUM_NOW);
	}
    }	

}

/*-------------------------------------------------------------
 *	FEDShowTokenMoniker
 *-------------------------------------------------------------
 *	Display Icon Moniker and ID in standard Size
 *	If token could not found ... 
 *		use standard folder icon, if token is "empty" (all fields are zero)
 *		show not-found-icon otherwise
 -------------------------------------------------------------*/
// swat stop in foldered::FEDShowTokenMoniker 
void  FEDShowTokenMoniker(GeodeToken tok, optr monikerObj) {
MemHandle	mh;
word 		monikerSize;
dword tokenDW;

    mh = 0;
    memcpy(&tokenDW, &tok.GT_chars[0], 4);

    /*
     * Set up token moniker
     */
    
    mh = InternalGetTokenMonikerBlock(tok, DS_STANDARD, VMS_ICON, &monikerSize);
    if ( mh ) 
    {
	@call monikerObj::MSG_GEN_REPLACE_VIS_MONIKER(VUM_NOW, 
			32,50,monikerSize,
			VMDT_VIS_MONIKER ,VMST_FPTR,(dword)MemLock(mh));
	MemFree(mh);
    }
    else {
	/*
	 * Token not found in TokenDB file. 
	 * For an emtpty token, show the default folder token
	 * For any other token show a "not found" image
	 */
	if ( (tokenDW==0) && (tok.GT_manufID==0) ) 
	{	
	    /*
	     *	No token set. Use default folder token nFDR,0
	     */
	    tok.GT_chars[0]='n'; tok.GT_chars[1]='F'; tok.GT_chars[2]='D'; 
	    tok.GT_chars[3]='R'; tok.GT_manufID=0;
	    mh = InternalGetTokenMonikerBlock(tok, DS_STANDARD, VMS_ICON, &monikerSize);
	    if (mh) 
	    {
		@call monikerObj::MSG_GEN_REPLACE_VIS_MONIKER(VUM_NOW, 
				32,50,monikerSize,
				VMDT_VIS_MONIKER ,VMST_FPTR,(dword)MemLock(mh));
		MemFree(mh);
	    }
	    else {
	    	/* nFDR,0 not found: bad, set empty image */
		@call monikerObj::MSG_GEN_REPLACE_VIS_MONIKER_TEXT("", 0);
	    }
	} 
	else {	   
	    @call monikerObj::MSG_GEN_REPLACE_VIS_MONIKER_OPTR(@IconNotFoundMoniker,VUM_NOW);
	}
    }
	
}	


/*--------------------- InternalGetTokenMonikerBlock ---------------------
 * Purpose:	Get the moniker in a memory block
 *		Allways try to fetch true color gstring moniker
 * Pass		dispSize DS_TINY  0
 *			DS_STANDARD  1
 *			DS_LARGE  2
 *			DS_HUGE  3
 *		style	VMS_TEXT  0
 *			VMS_ABBREV_TEXT  1
 *			VMS_GRAPHIC_TEXT  2
 *			VMS_ICON  3
 *			VMS_TOOL  4
 * 		*monikerSize: return: byte size of the moniker
 * Return:	Handle of memory block containing the moniker image
 ---------------------------------------------------------------------------*/
// swat stop in foldered::InternalGetTokenMonikerBlock
MemHandle InternalGetTokenMonikerBlock(GeodeToken token, 
				word dispSize, word style, 
				word *monikerSize) {
dword tokenDW;
MemHandle mh;
Boolean	found;

    mh = 0;
    memcpy(&tokenDW, &token.GT_chars[0], 4);

	/*
	 * TokenLoadMonikerBlock returns an 'alternative' moniker if the
	 * passed displaySize/style combination was not found
	 * e.g it retuns the 16 color moniker if no true color and
	 * no 8 bit color moniker was found
	 */
    found = TokenLoadMonikerBlock( tokenDW, token.GT_manufID,
	(dispSize << DT_DISP_SIZE_OFFSET)|
	(DAR_NORMAL << DT_DISP_ASPECT_RATIO_OFFSET)|
	DC_CF_RGB, 
	(style << VMSF_STYLE_OFFSET) | VMSF_GSTRING,
	monikerSize, &mh );

    if ( !found ) {
    	*monikerSize = 0;
    	return 0;
    	}
    return mh;
	
}



/*-------------------------------------------------------------
 *	FEDTokenIdToText
 *-------------------------------------------------------------
 *	convert token to text like "GDAT,0"
 *	return 'centered' text, if minLen > len(plain-token-id-text)
 *		you may pass zero to minLen
 -------------------------------------------------------------*/
// swat stop in foldered::FEDTokenIdToText 
void FEDTokenIdToText(GeodeToken tok, int minLen, char *retBuf) {
char buf[15];
int  n, left, l;

    /* setup token string */
    for ( n = 0; n< 4; n++ ) if (tok.GT_chars[n]==0) {tok.GT_chars[n]='-'; }
    sprintf(buf, "%c%c%c%c,%u", tok.GT_chars[0], tok.GT_chars[1], 
    			tok.GT_chars[2], tok.GT_chars[3], tok.GT_manufID);

    /*
     * center string, if minLen > strlen(buf)
     */
    l= strlen(buf);
    left = (minLen - (int)strlen(buf))/2;	// spaces on the left side
    if (left < 0) left = 0;
    retBuf[0] = 0;
    while (strlen(retBuf) < left) strcat(retBuf, " ");
    
    strcat(retBuf, buf);
    while( strlen(retBuf) < minLen) strcat(retBuf, " ");	    			
    
}


/*--------------------- FEDConfigureToolUI ---------------------
 * Purpose:	Activate/deactivate the UI according to the user's choice.
 ---------------------------------------------------------------------------*/
// swat stop in foldered::FEDConfigureToolUI
void FEDConfigureToolUI() {
word sel, numItems;

    @send @DialogObj(@CurrentIconTool)::  MSG_GEN_SET_NOT_USABLE(VUM_NOW);
    @send @DialogObj(@NewIconTool)::	  MSG_GEN_SET_NOT_USABLE(VUM_NOW);
    @send @DialogObj(@TokenDefaultTool):: MSG_GEN_SET_NOT_USABLE(VUM_NOW);
    @send @DialogObj(@CurrentIconHuge)::  MSG_GEN_SET_NOT_USABLE(VUM_NOW);
    @send @DialogObj(@NewIconHuge)::	  MSG_GEN_SET_NOT_USABLE(VUM_NOW);
    @send @DialogObj(@FEDTokenInfoGroup)::MSG_GEN_SET_NOT_USABLE(VUM_NOW);
    @send @DialogObj(@FEDTokenRangeGroup)::MSG_GEN_SET_NOT_USABLE(VUM_NOW);
    @send @DialogObj(@FEDTokenStyleGroup)::MSG_GEN_SET_NOT_USABLE(VUM_NOW);
    @send @DialogObj(@ClearTokenTrigger)::MSG_GEN_SET_NOT_USABLE(VUM_NOW);
    @send @DialogObj(@ClearTokenTrigger2)::MSG_GEN_SET_NOT_USABLE(VUM_NOW);
    @send @DialogObj(@SelectOkTrigger)::  MSG_GEN_SET_NOT_USABLE(VUM_NOW);
    @send @DialogObj(@SelectOkTrigger2):: MSG_GEN_SET_NOT_USABLE(VUM_NOW);

    /*
     * Redraw token list in any case
     */
    sel = @call @DialogObj(@FEDTokenList)::MSG_GEN_ITEM_GROUP_GET_SELECTION();
    numItems = @call @DialogObj(@FEDTokenList)::MSG_GEN_DYNAMIC_LIST_GET_NUM_ITEMS();
    @call @DialogObj(@FEDTokenList)::MSG_GEN_DYNAMIC_LIST_INITIALIZE(numItems);
    @send @DialogObj(@FEDTokenList)::MSG_GEN_ITEM_GROUP_SET_SINGLE_SELECTION(sel, FALSE);
    	
    if ( g_configBits & FED_CFG_TINY_ICONS_IN_DISPLAY) {
    	@send @DialogObj(@CurrentIconTool)::MSG_GEN_SET_USABLE(VUM_NOW);
    	@send @DialogObj(@NewIconTool)::MSG_GEN_SET_USABLE(VUM_NOW);
    	@send @DialogObj(@TokenDefaultTool)::MSG_GEN_SET_USABLE(VUM_NOW);
    	}

    if ( g_configBits & FED_CFG_HUGE_ICONS_IN_DISPLAY) {
    	@send @DialogObj(@CurrentIconHuge)::MSG_GEN_SET_USABLE(VUM_NOW);
    	@send @DialogObj(@NewIconHuge)::MSG_GEN_SET_USABLE(VUM_NOW);
    	}

    if ( g_configBits & FED_CFG_TOKEN_LIST_INFOS)
    	@send @DialogObj(@FEDTokenInfoGroup)::MSG_GEN_SET_USABLE(VUM_NOW);

    if ( g_configBits & FED_CFG_TOKEN_RANGE_GROUP)
    	@send @DialogObj(@FEDTokenRangeGroup)::MSG_GEN_SET_USABLE(VUM_NOW);

    if ( g_configBits & FED_CFG_TOKEN_STYLE_SELECTOR)
    	@send @DialogObj(@FEDTokenStyleGroup)::MSG_GEN_SET_USABLE(VUM_NOW);

    if ( g_configBits & FED_CFG_APPLY_BUTTONS_ON_TOP) {
    	@send @DialogObj(@ClearTokenTrigger)::MSG_GEN_SET_USABLE(VUM_NOW);
    	@send @DialogObj(@SelectOkTrigger)::MSG_GEN_SET_USABLE(VUM_NOW);
    } else {
    	@send @DialogObj(@ClearTokenTrigger2)::MSG_GEN_SET_USABLE(VUM_NOW);
    	@send @DialogObj(@SelectOkTrigger2)::MSG_GEN_SET_USABLE(VUM_NOW);
    }


}

/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  +                                                                         +
  +	Handle folder list				            	    +
  +                                                                         +
  ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/


/*-------------------------------------------------------------
 *	FEDShowFolderToken
 *-------------------------------------------------------------
 *	Read and Display Icon for a folder
 *	Return: currently used token
 -------------------------------------------------------------*/
GeodeToken FEDShowFolderToken(char *fileName,	DiskHandle dh, char *path) {
word fileAttrs;
GeodeToken fileToken, creatorToken;
GeosFileType fileType;
FileExtAttrDesc	attrDesc[4];	/* Array 0..3 */

    FilePushDir();
    FileSetCurrentPath(dh,path);


    /* Read extended attributes */
    @SetAttrDesc(attrDesc[0],FEA_TOKEN,&fileToken,sizeof(GeodeToken));
    @SetAttrDesc(attrDesc[1],FEA_CREATOR,&creatorToken,sizeof(GeodeToken));
    @SetAttrDesc(attrDesc[2],FEA_FILE_TYPE,&fileType,sizeof(GeosFileType));
    @SetAttrDesc(attrDesc[3],FEA_FILE_ATTR,&fileAttrs,1);
    FileGetPathExtAttributes(fileName,FEA_MULTIPLE,attrDesc,4);

    /* Display information */
    FEDShowToken(fileToken, @DialogObj(@CurrentIconID), @DialogObj(@CurrentIconStdDisplay), 
  			@DialogObj(@CurrentIconHuge), @DialogObj(@CurrentIconTool));
  

    FilePopDir();
  
    /* 
     * The returned token will be selected in the token list.
     * If the token is empty (all values are zero) return default folder token.
     */
  
    do {
  	if (fileToken.GT_manufID != 0) break;
  	if (fileToken.GT_chars[0] != 0) break;
  	if (fileToken.GT_chars[1] != 0) break;
  	if (fileToken.GT_chars[2] != 0) break;
  	if (fileToken.GT_chars[3] != 0) break;
  	
	fileToken.GT_chars[0]='n'; fileToken.GT_chars[1]='F'; fileToken.GT_chars[2]='D'; 
	fileToken.GT_chars[3]='R'; fileToken.GT_manufID=0;  
    } while (FALSE);
  
    return fileToken;
}


/*-------------------------------------------------------------
 * MSG_FED_QUERY_FOLDER	
 *-------------------------------------------------------------
 *	void GEN_DYNAMIC_LIST_QUERY_MSG (optr list, word item);
 *	Update item moniker in the folder list
-------------------------------------------------------------*/
// stop in foldered::FolderEdInteractionFED_QUERY_FOLDER
@method FolderEdInteractionClass, MSG_FED_QUERY_FOLDER {
FileLongName		fName;
SelectedFilesStruct	*fileInfo;

    if (!g_mh) strcpy(fName, "---");
    else {
	fileInfo = MemLock(g_mh);
	strcpy(fName, fileInfo->entry[item].FOIE_name);
	MemUnlock(g_mh);	
    }
    @send list::MSG_GEN_DYNAMIC_LIST_REPLACE_ITEM_TEXT(item, fName);
}


/*-------------------------------------------------------------
 * MSG_FED_APPLY_FOLDER	
 *-------------------------------------------------------------
 *	GEN_ITEM_GROUP_APPLY_MSG ( word selection = cx,
 * 			    	    word numSelections = bp,
 *				    GenItemGroupStateFlags stateFlags = dl);
 *	
-------------------------------------------------------------*/
// stop in foldered::FolderEdInteractionFED_APPLY_FOLDER
@method FolderEdInteractionClass, MSG_FED_APPLY_FOLDER {
GeosFileType 		fileType;
FileAttrs		attrs;
FileLongName		fileName;
SelectedFilesStruct	*fileInfo;
GeodeToken		tok;
int			sel;


    fileInfo = MemLock(g_mh);
    strcpy(fileName, fileInfo->entry[selection].FOIE_name);
    tok = FEDShowFolderToken(fileName,	
    			fileInfo->header.FQTH_diskHandle,
    			fileInfo->header.FQTH_pathname);
    				
    fileType = fileInfo->entry[selection].FOIE_type;
    attrs = fileInfo->entry[selection].FOIE_attrs;
    MemUnlock(g_mh);
    
    /* Redraw CurrentIconGroup to remove possible artefacts */
    @call @DialogObj(@CurrentIconGroup)::MSG_GEN_SET_NOT_USABLE(VUM_DELAYED_VIA_UI_QUEUE);
    @send @DialogObj(@CurrentIconGroup)::MSG_GEN_SET_USABLE(VUM_NOW);

    /* If currently no token selected, show currently used token in Tokenlist 
     * This only happens at startup, but not when the user selects another folder */
    sel = @call @DialogObj(@FEDTokenList)::MSG_GEN_ITEM_GROUP_GET_SELECTION();    
    if (sel==GIGS_NONE) FEDSelectToken(tok, TRUE);

}


/*-------------------------------------------------------------
 * MSG_FED_APPLY_CHANGE_ALL
 *-------------------------------------------------------------
 *	GEN_BOOLEAN_GROUP_APPLY_MSG (word selectedBooleans = cx,
 *				     word indeterminateBooleans = dx,
 *				     word modifiedBooleans = bp);  
 *	
-------------------------------------------------------------*/
// stop in foldered::FolderEdInteractionFED_APPLY_CHANGE_ALL
@method FolderEdInteractionClass, MSG_FED_APPLY_CHANGE_ALL {

    if ( selectedBooleans & FED_CFG_APPLY_TO_ALL ) {
    	g_configBits |= FED_CFG_APPLY_TO_ALL;
    	@send @DialogObj(@SelectFolderList)::MSG_GEN_SET_NOT_ENABLED(VUM_NOW);
    	
    } else {
    	g_configBits &= ~FED_CFG_APPLY_TO_ALL;
    	@send @DialogObj(@SelectFolderList)::MSG_GEN_SET_ENABLED(VUM_NOW);
    }
}

/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  +                                                                         +
  +	Handle token list				            	    +
  +	-----------------------				            	    +
  +	- select, query and apply token					    +	
  +	- configure token list (ID-range, token to display)		    +	
  +                                                                         +
  ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/


/*-------------------------------------------------------------
 * FEDSelectToken
 *-------------------------------------------------------------
 *	Select given Token in the tokenlist
 *	selectFirst = TRUE: Select first list entry if token was not found 
 * 			or is not displayed yet
 *		      FALSE: Don't change selection in this case
 *-------------------------------------------------------------*/
void FEDSelectToken(GeodeToken tok, Boolean selectFirst) {
TokenListStruct	*tokenList;
int 	n, manufID, idx;
Boolean found;

		
    tokenList = MemLock(g_tokenList);
    found  = FALSE;
    idx = 0;
    manufID = tok.GT_manufID;
    for ( n = 0; n < tokenList->tokenCount; n++ ) {
    
    	if (manufID != tokenList->token[n].GT_manufID) continue;
    	
    	if ( memcmp(&tok, &(tokenList->token[n]), sizeof(GeodeToken)) == 0 ) {
    	    /*
    	     * token found. See if currently displayed
    	     * set found = TRUE and asign idx for this case
    	     * leave idx = 0 and found = FALSE otherwise
    	     */
    	    if ( n < tokenList->firstIndex) break;
    	    if ( n >= (tokenList->firstIndex + tokenList->tokensToShow)) break;
    	    found = TRUE;
    	    idx = n - tokenList->firstIndex;
    	    break;
    	}
    }
    MemUnlock(g_tokenList);
    
    /*
     * Select proper list entry
     */
    if ( found || selectFirst) {
	@send @DialogObj(@FEDTokenList)::MSG_GEN_ITEM_GROUP_SET_SINGLE_SELECTION(idx, FALSE);
	@send @DialogObj(@FEDTokenList)::MSG_GEN_ITEM_GROUP_SET_MODIFIED_STATE(TRUE);
	@send @DialogObj(@FEDTokenList)::MSG_GEN_APPLY();
    }
    

}


/*-------------------------------------------------------------
 * ReplaceTokenItemMoniker
 *-------------------------------------------------------------
 *	Replace an item in the token list by a gstring, that
 *	contains am main token moniker and the tiny tool 
 *	moniker, if we have any
-------------------------------------------------------------*/
// stop in foldered::ReplaceTokenItemMoniker
void ReplaceTokenItemMoniker(optr list, word item, GeodeToken tok) {
MemHandle	gsHandle;
GStateHandle	gsState;
word 		gsChunk; // ChunkHandle 	gsChunk;
optr		gsOptr;

word		lElem;
Handle		monikerGString;
MemHandle 	mh;
word 		monikerSize;
byte 		*bPtr;
VisMonikerWithGString	*monikerPtr;
int		x, y;

    /*
     * Create Gstring to hold Images
     */
     
    gsHandle = MemAllocLMem(LMEM_TYPE_GENERAL, 0);
    gsState = GrCreateGString( gsHandle, GST_CHUNK, &gsChunk);
    gsOptr = ConstructOptr(gsHandle, gsChunk);

    /*
     *	Load main moniker an draw it to the gstring
     */
    mh = InternalGetTokenMonikerBlock(tok, g_displaySize, g_tokenStyle, &monikerSize); 
    if ( mh ) {

	bPtr = MemLock(mh);
	monikerPtr = (VisMonikerWithGString*)bPtr;
	
	// bPtr must point to the gstring 
	bPtr += sizeof(VisMonikerWithGString);
	monikerGString = GrLoadGString(PtrToSegment(bPtr), GST_PTR, PtrToOffset(bPtr));

	
	// Center moniker 
	x = (TOKEN_LIST_ITEM_WIDTH - monikerPtr->VMWGS_common.VM_width)/2;
	y = (SVGA_MONIER_SPACE_Y - monikerPtr->VMWGS_height)/2;
	y += TOKEN_LIST_SVGA_MONIKER_TOP;
	GrDrawGString(gsState, monikerGString, x, y, 0, &lElem);
	GrDestroyGString(monikerGString, NULL, GSKT_LEAVE_DATA);

	MemFree(mh);
    } else {
    	/* IMHO this sould not happen */
    	GrDrawText(gsState, 0, TOKEN_LIST_TINY_MONIKER_TOP/3, "NOT found", 0);
    }	

    
    /*
     *	Load tiny tool moniker (if any) an draw it to the gstring
     */
    if ( g_configBits & FED_CFG_TINY_ICONS_IN_LIST) {
	mh = InternalGetTokenMonikerBlock(tok, DS_TINY, VMS_TOOL, &monikerSize);
	if ( mh ) {

	    bPtr = MemLock(mh);
	    monikerPtr = (VisMonikerWithGString*)bPtr;
	    bPtr += sizeof(VisMonikerWithGString);
	    monikerGString = GrLoadGString(PtrToSegment(bPtr), GST_PTR, PtrToOffset(bPtr));

	    // check size before draw it centered at bottom
	    x = monikerPtr->VMWGS_common.VM_width;
	    y = monikerPtr->VMWGS_height;

	    if ( (x<TINY_MONIKER_SPACE_XY) && (y<TINY_MONIKER_SPACE_XY) ) {
		x = (TINY_MONIKER_SPACE_XY - x)/2;
		y = (TINY_MONIKER_SPACE_XY - y)/2;
		y += TOKEN_LIST_TINY_MONIKER_TOP;
		GrDrawGString(gsState, monikerGString, x, y, 0, &lElem);
		GrDestroyGString(monikerGString, NULL, GSKT_LEAVE_DATA);
	    }
	    MemFree(mh);

	}
    }



    GrEndGString(gsState);
    
    @call list::MSG_GEN_DYNAMIC_LIST_REPLACE_ITEM_MONIKER(item,0,	// item, flags
    			TOKEN_LIST_ITEM_HIGHT, TOKEN_LIST_ITEM_WIDTH,0,			// Height, width, lenght
			VMDT_GSTRING,VMST_OPTR,gsOptr);	// dataType, sourceType, source

    GrDestroyGString(gsState,0,GSKT_KILL_DATA);
    MemFree(gsHandle);
	
}

  
/*-------------------------------------------------------------
 * MSG_FED_QUERY_TOKEN_LIST	
 *-------------------------------------------------------------
 *	void GEN_DYNAMIC_LIST_QUERY_MSG (optr list, word item);
 *	Update item moniker in the token list
-------------------------------------------------------------*/
// stop in foldered::FolderEdInteractionFED_QUERY_TOKEN_LIST
@method FolderEdInteractionClass, MSG_FED_QUERY_TOKEN_LIST {
TokenListStruct	*tokenList;
GeodeToken tok;

    tokenList = MemLock(g_tokenList);
    tok = tokenList->token[item + tokenList->firstIndex];
    MemUnlock(g_tokenList);

    ReplaceTokenItemMoniker(list, item, tok);
}

/*-------------------------------------------------------------
 * MSG_FED_APPLY_TOKEN_LIST
 *-------------------------------------------------------------
 *	GEN_ITEM_GROUP_APPLY_MSG ( word selection = cx,
 * 			    	    word numSelections = bp,
 *				    GenItemGroupStateFlags stateFlags = dl);
 *	
-------------------------------------------------------------*/
// stop in foldered::FolderEdInteractionFED_APPLY_TOKEN_LIST
@method FolderEdInteractionClass, MSG_FED_APPLY_TOKEN_LIST {
TokenListStruct	*tokenList;
GeodeToken tok;

    tokenList = MemLock(g_tokenList);
    tok = tokenList->token[selection + tokenList->firstIndex];
    g_selectedToken = tok;
    MemUnlock(g_tokenList);


    FEDShowToken(tok, @DialogObj(@NewIconID), @DialogObj(@NewIconStdDisplay), 
    			@DialogObj(@NewIconHuge), @DialogObj(@NewIconTool));

    /* Redraw NewIconGroup to remove possible artefacts */
    @call @DialogObj(@NewIconGroup)::MSG_GEN_SET_NOT_USABLE(VUM_DELAYED_VIA_APP_QUEUE);
    @send @DialogObj(@NewIconGroup)::MSG_GEN_SET_USABLE(VUM_NOW);
/**/
}

/*-------------------------------------------------------------
 * MSG_FED_APPLY_TOKEN_RANGE
 *-------------------------------------------------------------
 *	
-------------------------------------------------------------*/
// stop in foldered::FolderEdInteractionFED_APPLY_TOKEN_RANGE
@method FolderEdInteractionClass, MSG_FED_APPLY_TOKEN_RANGE {
TokenListStruct	*list;
word minID, maxID, n;
Boolean found;
int		curIdx;
GeodeToken	curToken;


    /*
     * Find out current selection an token 
     */ 
     curIdx = @call @DialogObj(@FEDTokenList)::MSG_GEN_ITEM_GROUP_GET_SELECTION(); 
     if (curIdx == GIGS_NONE) curIdx = 0; 
     list = MemLock(g_tokenList); 
     curToken = list->token[curIdx + list->firstIndex]; 
     MemUnlock(g_tokenList);
	 

    minID = @call @DialogObj(@FEDManufIDMinimumValue)::MSG_GEN_VALUE_GET_VALUE();
    maxID = @call @DialogObj(@FEDManufIDMaximumValue)::MSG_GEN_VALUE_GET_VALUE();
    if ( minID > maxID ) {
    	word tmp = minID;
    	minID=maxID;
    	maxID=tmp;
	@call @DialogObj(@FEDManufIDMinimumValue)::MSG_GEN_VALUE_SET_VALUE(minID, FALSE);
	@call @DialogObj(@FEDManufIDMaximumValue)::MSG_GEN_VALUE_SET_VALUE(maxID, FALSE);
	}
	
    list = MemLock(g_tokenList);

    do {    
	found = FALSE;
	list->firstIndex = 0;
	list->tokensToShow = 0;
	
	// find first index to display
	for (n = 0; n < list->tokenCount; n++ ) {
	    if (list->token[n].GT_manufID >= minID ) {
		list->firstIndex = n;
		found = TRUE;
		break;
		}
	}
 	if ( !found ) break;		// minID too large
 	
 	// find number of token to display
 	list->tokensToShow = 0;
 	for (n = list->firstIndex; n < list->tokenCount; n++) {
 	    if (list->token[n].GT_manufID > maxID ) break;
 	    list->tokensToShow++;
 	    }
 	
 	} while(FALSE);
    
    // if there are no token to display, list->tokensToShow will be zero
    // --> no extra handling required for the list
    @send @DialogObj(@FEDTokenList)::MSG_GEN_DYNAMIC_LIST_INITIALIZE(list->tokensToShow);
    @send @DialogObj(@FEDTokenInfoDisplayed)::MSG_GEN_VALUE_SET_INTEGER_VALUE(list->tokensToShow, FALSE);

    // ... but disable "Change Token" button and clear "new" token display
    if (0==list->tokensToShow) {
    	@send @DialogObj(@SelectOkTrigger)::MSG_GEN_SET_NOT_ENABLED(VUM_NOW);
    	@send @DialogObj(@SelectOkTrigger2)::MSG_GEN_SET_NOT_ENABLED(VUM_NOW);
    	
    	@call @DialogObj(@NewIconID)::MSG_GEN_REPLACE_VIS_MONIKER_TEXT("",0);
    	@call @DialogObj(@NewIconStdDisplay)::MSG_GEN_REPLACE_VIS_MONIKER_TEXT("",0);
    	@call @DialogObj(@NewIconTool)::MSG_GEN_REPLACE_VIS_MONIKER_TEXT("",0);
    	@call @DialogObj(@NewIconHuge)::MSG_GEN_REPLACE_VIS_MONIKER_TEXT("",0);
    	}
    else {
    	@send @DialogObj(@SelectOkTrigger)::MSG_GEN_SET_ENABLED(VUM_NOW);
    	@send @DialogObj(@SelectOkTrigger2)::MSG_GEN_SET_ENABLED(VUM_NOW);
    	}


    MemUnlock(g_tokenList);
    
    /* 
     *	try to restore previously selected token
     */
    if (list->tokensToShow) FEDSelectToken(curToken, TRUE);


    /* Redraw NewIconGroup to remove possible artefacts */
    @call @DialogObj(@NewIconGroup)::MSG_GEN_SET_NOT_USABLE(VUM_DELAYED_VIA_UI_QUEUE);
    @send @DialogObj(@NewIconGroup)::MSG_GEN_SET_USABLE(VUM_NOW);
/**/
}



/*-------------------------------------------------------------
 * MSG_FED_APPLY_TOKEN_TYPE
 *-------------------------------------------------------------
 *	Select a new display size and toke style to display in list
-------------------------------------------------------------*/
// stop in foldered::FolderEdInteractionFED_APPLY_TOKEN_TYPE
@method FolderEdInteractionClass, MSG_FED_APPLY_TOKEN_TYPE {
TokenListStruct	*list;
word curSel, count;

    g_tokenStyle = @call @DialogObj(@FEDTokenStyleSelector)::MSG_GEN_ITEM_GROUP_GET_SELECTION();
    g_displaySize = @call @DialogObj(@FEDDisplaySizeSelector)::MSG_GEN_ITEM_GROUP_GET_SELECTION();
   
    list = MemLock(g_tokenList);
    count = list->tokensToShow;
    MemUnlock(g_tokenList);
    
	/*
	 * Update FEDTokenList and NewIcon UI
	 */    
    curSel = @call @DialogObj(@FEDTokenList)::MSG_GEN_ITEM_GROUP_GET_SELECTION();
    @call @DialogObj(@FEDTokenList)::MSG_GEN_DYNAMIC_LIST_INITIALIZE(count);
    @send @DialogObj(@FEDTokenList)::MSG_GEN_ITEM_GROUP_SET_SINGLE_SELECTION(curSel, FALSE);
    @send @DialogObj(@FEDTokenList)::MSG_GEN_ITEM_GROUP_SET_MODIFIED_STATE(TRUE);
    @send @DialogObj(@FEDTokenList)::MSG_GEN_APPLY();

	/*
	 * Update Token of selected folder
	 */    
    @send @DialogObj(@SelectFolderList)::MSG_GEN_ITEM_GROUP_SET_MODIFIED_STATE(TRUE);
    @send @DialogObj(@SelectFolderList)::MSG_GEN_APPLY();
 
}
  

/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  +                                                                         +
  +	Change tokens				            	    +
  +                                                                         +
  ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/

/*-------------------------------------------------------------
 * MSG_FED_CHANGE_TOKEN	
 *-------------------------------------------------------------
 *	void (void);
 *	apply new token
-------------------------------------------------------------*/
// stop in foldered::FolderEdInteractionFED_CHANGE_TOKEN
@method FolderEdInteractionClass, MSG_FED_CHANGE_TOKEN {
FileLongName		fileName;
SelectedFilesStruct	*fileInfo;
word		 	selection, n, count;
Boolean			err;

    FilePushDir();

	/*
	 * Enter path 
	 */
    fileInfo = MemLock(g_mh);
    FileSetCurrentPath(	fileInfo->header.FQTH_diskHandle,
			fileInfo->header.FQTH_pathname);
    MemUnlock(g_mh);

    if ( g_configBits & FED_CFG_APPLY_TO_ALL) {
    	/*
    	 * Apply to any folder in the SelectFolderList
    	 */
    	count = @call @DialogObj(@SelectFolderList)::MSG_GEN_DYNAMIC_LIST_GET_NUM_ITEMS();
    	err = FALSE;
    	for ( n = 0; n < count; n++ ) {
    	    fileInfo = MemLock(g_mh);
    	    strcpy(fileName, fileInfo->entry[n].FOIE_name);
    	    MemUnlock(g_mh);
   	    err |= FEDChangeSingleToken(fileName);
   	}
   	
	if (err) { ErrorBoxOptr(@ErrorChangeToken2); 
    	} else { 
	    MessageBoxOptr(@ChangeTokenOK2); 
	}
	@send @DialogObj(@SelectFolderList)::MSG_GEN_ITEM_GROUP_SET_MODIFIED_STATE(TRUE);
	@send @DialogObj(@SelectFolderList)::MSG_GEN_APPLY();
	
    } else {
    	/*
    	 * Only apply to currently selected folder. This is also ok if the user has
    	 * called the tool for only one folder (but the list is invisible in this case)
    	 */
	selection = @call @DialogObj(@SelectFolderList)::MSG_GEN_ITEM_GROUP_GET_SELECTION(); 
	fileInfo = MemLock(g_mh);
	strcpy(fileName, fileInfo->entry[selection].FOIE_name);
	MemUnlock(g_mh);
	
	err = FEDChangeSingleToken(fileName);
	if (err) { ErrorBoxOptr(@ErrorChangeToken);
    	} else { 
	    MessageBoxOptr(@ChangeTokenOK); 
	}
    }    
    
    /*
     *	Force display the new token of the currently selected folder
     */
    @send @DialogObj(@SelectFolderList)::MSG_GEN_ITEM_GROUP_SET_MODIFIED_STATE(TRUE);
    @send @DialogObj(@SelectFolderList)::MSG_GEN_APPLY();
    
    FilePopDir();
    
}

/*-------------------------------------------------------------
 * FEDChangeSingleToken
 *-------------------------------------------------------------
 *	Change the token for one particular folder 
 *	return TRUE if there was an error
-------------------------------------------------------------*/
Boolean FEDChangeSingleToken(char *fileName) {
GeosFileType 		fileType;
FileAttrs		fileAttrs;

    fileAttrs = FileGetAttributes(fileName);
    if ( ThreadGetError() ) {
    	// folder not found - very strange. 
    	ErrorBoxOptr(@ErrorFileNotFound);
    	return TRUE;	
    }

	/*
	 * Depending on fileType, set new token
	 */
    FileGetPathExtAttributes (fileName, FEA_FILE_TYPE, &fileType, sizeof(GeosFileType));

    switch (fileType) {
	case GFT_DIRECTORY:
	    FileSetPathExtAttributes (fileName, FEA_TOKEN, &g_selectedToken, sizeof(GeodeToken));
	    break;
  	case GFT_NOT_GEOS_FILE:
  	    if ( fileAttrs & FA_SUBDIR ) {
	    	FEDChangeDosFolderToken(fileName);
	    break;
  	    }
	default: 
	    // IMHO this should never happen
	    return TRUE;
    }	   
    
    if ( ThreadGetError() )  { 
    	return TRUE;
    }
    return FALSE;

}

/*-------------------------------------------------------------
 * FEDChangeDosFolderToken
 *-------------------------------------------------------------
 *	Change the token for a folder without a dirname file
-------------------------------------------------------------*/
void FEDChangeDosFolderToken(char *fileName) {
FileHandle fh;
ProtocolNumber proto;
GeosFileType type;

    FilePushDir();
    do {
    	FileSetCurrentPath(0, fileName);
    	if (ThreadGetError() ) break;
    	
	    /*
	     * Create and set up a dirname file
	     */
	fh = FileCreate("@dirname.000",FILE_CREATE_TRUNCATE |
			FILE_ACCESS_RW | FILE_DENY_RW,
			0);
	if ( fh == 0 ) break;
	
	proto.PN_major = 1; proto.PN_minor = 0;
	type = GFT_DIRECTORY;
	
	FileSetHandleExtAttributes(fh,FEA_PROTOCOL, &proto,sizeof(ProtocolNumber));
	FileSetHandleExtAttributes(fh,FEA_FILE_TYPE, &type,sizeof(GeosFileType));
	FileSetHandleExtAttributes(fh,FEA_NAME, fileName,FILE_LONGNAME_BUFFER_SIZE);
	FileSetHandleExtAttributes(fh,FEA_TOKEN, &g_selectedToken, sizeof(GeodeToken));
    
    	FileClose(fh, FALSE);
    
    } while(FALSE);
    FilePopDir();
}

/*-------------------------------------------------------------
 * MSG_FED_CLEAR_TOKEN	
 *-------------------------------------------------------------
 *	void (void);
 *	Set all tokenchars and manufID to zero for this folder
 *	This will force the file manager to use the default folder token
-------------------------------------------------------------*/
// stop in foldered::FolderEdInteractionFED_CLEAR_TOKEN
@method FolderEdInteractionClass, MSG_FED_CLEAR_TOKEN {
GeodeToken 	savedToken;
int cmd;

    cmd = QuestionBoxOptr(@QuestionClearToken);
    if ( cmd != IC_YES) return;
    /* 
     * simply set selected token to zero and call the set-new-token handler
     */
    savedToken = g_selectedToken;
    memset(&g_selectedToken, 0, sizeof(GeodeToken) );
    @call oself::MSG_FED_CHANGE_TOKEN(); 
    g_selectedToken = savedToken;
    

}

/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  +                                                                         +
  +	CODE für WordValueClass				            	    +
  +	-----------------------				            	    +
  +	Simple implementation to display word sized values in the range	    +
  +	from 0 to 65535. No decimal places etc. are supported.		    +
  +									    +
  +	Use MSG_GEN_VALUE_GET_VALUE to get the word value		    +
  +	Use MSG_GEN_VALUE_SET_VALUE to set the word value		    +
  +	Do not use the _INTEGER_ messages for this purposes.		    +
  +                                                                         +
  ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/

@classdecl WordValueClass;


/*      MSG_GEN_VALUE_GET_MAX_TEXT_LEN
 *      Default handler is OK.
 *      Parameter:      byte (void)
 */
/*
@method WordValueClass, MSG_GEN_VALUE_GET_MAX_TEXT_LEN {
UserStandardSound(SST_ERROR);	// debugging
	return 10;
	}

/*      MSG_GEN_VALUE_GET_VALUE_TEXT
 *      converts a instance field value to a text string
 *      Parameter:      void ( char *buffer, GenValeType   valueType)
 */

@method WordValueClass, MSG_GEN_VALUE_GET_VALUE_TEXT {
word    val;
@callsuper();
/* read requested instance field*/
	switch (valueType) {
		case GVT_VALUE: val = (pself->GVLI_value);
						break;
		case GVT_MINIMUM:       val = (pself->GVLI_minimum);
						break;
		case GVT_MAXIMUM:       val = (pself->GVLI_maximum);
						break;
		case GVT_INCREMENT:     val = (pself->GVLI_increment);
						break;
		case GVT_LONG:          val = 65000 ;
						break;
		default:        val = 65001;
		}
/* in Text konvertieren */
	sprintf(buffer,"%u",val);
}

/*      MSG_GEN_VALUE_SET_VALUE_FROM_TEXT
 *      Belegt ein instance-feld mit einem textual vorgegebenen Wert
 *      Parameter:      void (char *text, GenValueType valueType )
 */
// stop in foldered::WordValueGEN_VALUE_SET_VALUE_FROM_TEXT
@method WordValueClass, MSG_GEN_VALUE_SET_VALUE_FROM_TEXT {
dword   erg;
/* convert text */
	erg =0;
	while ( *text != 0 ) {
		if ( *text == '-' )     {
			@send oself::MSG_GEN_VALUE_SET_VALUE_TO_MINIMUM();
			erg = 0;                /* Minimum */
			break;
			}
		// erg = erg*10; <<-- forces ansic protocol 1.008 which is not supported by 
		// earlier PC/GEOS versions (4.13 e.g) --> platform statemet required
		erg = (erg<<3) + (erg<<1);	// avoids platform statement
		erg += (dword)(*text - '0');
		text++;
		}
		if ( erg > 0xFFFF ) {
				@send oself::MSG_GEN_VALUE_SET_VALUE_TO_MAXIMUM();
				erg = 0xFFFF;
				}
/* set instance field */
	switch (valueType) {
		case GVT_VALUE: pself->GVLI_value = (dword)erg ;
						break;
		case GVT_MINIMUM:       pself->GVLI_minimum = (dword)erg;
						break;
		case GVT_MAXIMUM:       pself->GVLI_maximum = (dword)erg;
						break;
		case GVT_INCREMENT:     pself->GVLI_increment = (dword)erg;
						break;
		}
}

